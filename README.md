# AutoDuo

Userscript для автоматического решения математических заданий в Duolingo Math.

## Возможности

Скрипт автоматически решает **18 типов заданий**:

| Солвер | Тип задания |
|--------|-------------|
| `InteractiveSliderSolver` | Числовые линии со слайдером (NumberLine) |
| `InteractiveSpinnerSolver` | Круговые диаграммы для выбора сегментов |
| `ExpressionBuildSolver` | Построение математических выражений |
| `FactorTreeSolver` | Разложение чисел на множители |
| `MatchPairsSolver` | Сопоставление пар (дроби, округление, блок-диаграммы) |
| `PatternTableSolver` | Таблицы с числовыми паттернами |
| `BlockDiagramChoiceSolver` | Блок-диаграмма с выбором числа из вариантов |
| `BlockDiagramTextInputSolver` | Блок-диаграмма с текстовым вводом числа |
| `RoundToNearestSolver` | Округление чисел до ближайших 10/100/1000 |
| `SelectEquivalentFractionSolver` | Выбор эквивалентной дроби |
| `ComparisonChoiceSolver` | Сравнения с выбором (`1/4 > ?`) |
| `SelectOperatorSolver` | Выбор оператора сравнения |
| `PieChartTextInputSolver` | Ввод дроби по круговой диаграмме |
| `PieChartSelectFractionSolver` | Выбор дроби по pie chart |
| `SelectPieChartSolver` | Выбор pie chart по уравнению |
| `EquationBlankSolver` | Уравнения с пропуском и выбором |
| `TypeAnswerSolver` | Ввод ответа (универсальный) |

## Установка

### Через userscript менеджер

1. Установите [Tampermonkey](https://www.tampermonkey.net/) или [Violentmonkey](https://violentmonkey.github.io/)

2. Создайте новый скрипт и вставьте содержимое из `dist/autoduo.user.js`

### Через консоль браузера

1. Откройте Duolingo Math
2. Откройте Developer Tools (F12)
3. Вставьте содержимое `dist/autoduo.user.js` в консоль
4. Нажмите Enter

## Использование

После запуска в углу экрана появятся панели:

**Панель управления (справа вверху):**
- **Start** — запустить автоматическое решение всех заданий
- **Stop** — остановить автоматический режим
- **Solve 1** — решить только текущее задание

**Панель логов (слева вверху):**
- Отображает все действия скрипта
- **Copy** — скопировать логи в буфер обмена
- **Clear** — очистить логи

## Разработка

```bash
# Клонировать репозиторий
git clone https://github.com/bitdittowit/autoduo.git
cd autoduo

# Установить зависимости
npm install

# Запустить проверки
npm run check        # typecheck + lint + tests

# Собрать бандл
npm run build        # создаёт dist/autoduo.user.js

# Отдельные команды
npm run typecheck    # проверка типов TypeScript
npm run lint         # проверка ESLint
npm run lint:fix     # автоисправление
npm run test         # запуск тестов (watch mode)
npm run test:run     # запуск тестов (single run)
```

## Архитектура

```
src/
├── config.ts           # Конфигурация
├── types.ts            # TypeScript типы
├── index.ts            # Entry point
│
├── math/               # Математические утилиты
│   ├── fractions.ts    # Операции с дробями
│   ├── rounding.ts     # Округление
│   ├── expressions.ts  # Вычисление выражений
│   └── equations.ts    # Решение уравнений
│
├── parsers/            # Парсеры DOM элементов
│   ├── latex.ts        # LaTeX утилиты
│   ├── KatexParser.ts  # KaTeX элементы
│   ├── FractionParser.ts
│   ├── BlockDiagramParser.ts
│   └── PieChartParser.ts
│
├── solvers/            # Солверы заданий (16 штук)
│   ├── BaseSolver.ts   # Базовый класс
│   └── *Solver.ts      # Конкретные солверы
│
├── dom/                # DOM утилиты
│   ├── selectors.ts    # CSS селекторы
│   ├── waiters.ts      # Ожидание элементов
│   └── interactions.ts # Клики, ввод
│
├── core/               # Ядро логики
│   ├── ChallengeDetector.ts
│   ├── SolverRegistry.ts
│   └── AutoRunner.ts
│
└── ui/                 # UI компоненты
    ├── LogPanel.ts
    └── ControlPanel.ts
```

## Статистика

- 18 солверов
- 178+ тестов
- ~60 TypeScript файлов
- 100% покрытие типами

## Последние изменения

### v1.0.17 (2026-01-29)
- **Новый тип задания:** "Find the greatest common factor" (НОД/GCF) с **визуальными блок-диаграммами**
  - Отличие от v1.0.16: варианты ответов - не текст, а **iframe с SVG блоками**
  - Таблица показывает визуальные представления НОД:
    * `14,12` → [диаграмма с 2 блоками]
    * `15,12` → [диаграмма с 3 блоками]
    * `16,12` → `?` (нужно найти)
  - Варианты ответов: iframe с блок-диаграммами разных размеров
  - Алгоритм:
    * Вычисляет НОД (GCF): `GCF(16,12) = 4`
    * Парсит `srcdoc` каждого iframe
    * Подсчитывает `<path>` и `<rect>` элементы в SVG (это блоки)
    * Выбирает iframe с правильным количеством блоков
  - Примеры решения:
    * GCF(16, 12) = 4 → выбирает [4 блока] из [4 блока] vs [8 блоков] ✓
    * GCF(18, 24) = 6 → выбирает [6 блоков] из [6 блоков] vs [12 блоков] ✓
    * GCF(20, 15) = 5 → выбирает [5 блоков] из [10 блоков] vs [5 блоков] ✓
  - Регистрация: **ПЕРЕД** `GreatestCommonFactorSolver` (более высокий приоритет)
  - Проверяет наличие iframe → если есть, решает визуальный вариант
  - Если iframe нет → переключается на текстовый `GreatestCommonFactorSolver`
  - Тесты: 6 новых тестов (всего 204)

### v1.0.16 (2026-01-29)
- **Новый тип задания:** "Find the greatest common factor" (НОД/GCF)
  - Таблица с парами чисел и их наибольшим общим делителем:
    * `14,12` → `2`
    * `15,12` → `3`
    * `16,12` → `?` (нужно найти)
  - Варианты ответов: текстовые числа
  - Алгоритм Евклида для вычисления НОД:
    * GCF(16, 12): 16 % 12 = 4, 12 % 4 = 0 → **GCD = 4** ✓
    * GCF(18, 24): 24 % 18 = 6, 18 % 6 = 0 → **GCD = 6** ✓
    * GCF(20, 15): 20 % 15 = 5, 15 % 5 = 0 → **GCD = 5** ✓
  - Поддерживаемые заголовки:
    * "greatest common factor"
    * "GCF" / "GCD"
    * "наибольш" + "делител" (русский)
  - Примеры решения:
    * GCF(16, 12) = 4 → выбирает `4` из [`4`, `8`] ✓
    * GCF(18, 24) = 6 → выбирает `6` из [`6`, `12`] ✓
    * GCF(20, 15) = 5 → выбирает `5` из [`10`, `5`] ✓
  - Тесты: 5 новых тестов (всего 198)

### v1.0.15 (2026-01-29)
- **Новый тип задания:** "Select the least common multiple" с **визуальными блок-диаграммами**
  - Отличие от v1.0.14: варианты ответов - не текст, а **iframe с SVG блоками**
  - Таблица показывает визуальные представления НОК:
    * `7,7` → [диаграмма с 7 блоками]
    * `7,14` → [диаграмма с 14 блоками]
    * `7,21` → `?` (нужно найти)
  - Варианты ответов: iframe с блок-диаграммами разных размеров
  - Алгоритм:
    * Вычисляет НОК (LCM): `LCM(7,21) = 21`
    * Парсит `srcdoc` каждого iframe
    * Подсчитывает `<path>` и `<rect>` элементы в SVG (это блоки)
    * Выбирает iframe с правильным количеством блоков
  - Примеры решения:
    * LCM(7, 21) = 21 → выбирает [21 блок] из [19 блоков] vs [21 блок] ✓
    * LCM(6, 8) = 24 → выбирает [24 блока] из [24 блока] vs [48 блоков] ✓
  - Регистрация: **ПЕРЕД** `LeastCommonMultipleSolver` (более высокий приоритет)
  - Проверяет наличие iframe → если есть, решает визуальный вариант
  - Если iframe нет → переключается на текстовый `LeastCommonMultipleSolver`
  - Тесты: 5 новых тестов (всего 193)

### v1.0.14 (2026-01-29)
- **Новый тип задания:** "Select the least common multiple" (НОК)
  - Таблица с парами чисел и их наименьшими общими кратными
  - Пример: для пар `(2,5)→10`, `(3,5)→15`, нужно найти НОК для `(4,5)→?`
  - Алгоритм:
    * Вычисляет НОК по формуле: `LCM(a,b) = (a×b) / GCD(a,b)`
    * Использует алгоритм Евклида для НОД (GCD)
    * Находит строку с `?` в таблице
    * Выбирает правильный вариант ответа
  - Примеры решения:
    * LCM(4, 5) = 20 (кратные 4: 4,8,12,16,20; кратные 5: 5,10,15,20)
    * LCM(6, 8) = 24 (GCD=2, LCM=(6×8)/2=24)
    * LCM(12, 18) = 36 (GCD=6, LCM=(12×18)/6=36)
  - Удалено: `SelectLCMSolver.ts` (старая версия)
  - Тесты: 5 новых тестов (всего 188)

### v1.0.13 (2026-01-29)
- **Новый тип задания:** "Select the factors" (выбор делителей числа)
  - Пример: для числа 32 выбрать правильный список: `1, 4, 8, 16`
  - Неправильные варианты: `1, 400, 8, 16` (400 не делитель 32)
  - Алгоритм:
    * Вычисляет все делители числа
    * Проверяет каждый вариант ответа
    * Выбирает вариант, где ВСЕ числа - делители
    * Отклоняет варианты с неделителями
  - Тесты: 5 новых тестов (всего 183)

### v1.0.12 (2026-01-29)
- **Исправлено:** ExpressionBuildSolver ТАКЖЕ пропускал ExpressionBuild
  - Задание "Complete the equation" (`4=?`) с токенами `[80,5,"/",65,"/",35,20]`
  - **Логи:** `skipping NumberLine iframe (not ExpressionBuild)`
  - Результат: `no solver found for challenge`
  - **Причина:** ExpressionBuildSolver проверял NumberLine РАНЬШЕ ExpressionBuild
  - Проверка `srcdoc.includes('NumberLine')` срабатывала на библиотечный код
  - **Решение:** 
    * СНАЧАЛА проверка на `new ExpressionBuild` + `entries:`
    * Эта комбинация ОДНОЗНАЧНО указывает на ExpressionBuild компонент
    * ПОТОМ проверка NumberLine (если ExpressionBuild не найден)
  - Теперь оба солвера корректно различают типы заданий

### v1.0.11 (2026-01-29)
- **Исправлено:** InteractiveSliderSolver ошибочно определял ExpressionBuild как slider
  - Задание "Complete the equation" (`110=?`) с токенами
  - Правильный ответ: составить выражение `10⋅11`
  - Скрипт устанавливал `value=110` (как slider) вместо составления
  - Результат: неправильный ответ
  - **Причина:** ExpressionBuild iframe содержит NumberLine код библиотеки
  - **Решение:** Добавлена проверка на `new ExpressionBuild` + `entries:`
  - Теперь ExpressionBuild передается ExpressionBuildSolver

### v1.0.10 (2026-01-29)
- **Исправлено:** Обычные slider задания блокировались проверкой Factor Tree
  - Проверка `originalTree` была слишком широкой
  - Обычные NumberLine slider содержат похожие переменные
  - Задания "Get as close as you can" (`60÷20=?`) не решались
  - Теперь проверка требует **ДВА** условия:
    * `FactorTree` класс **И**
    * `originalTokens` (уникально для Factor Tree)
  - Все slider типы теперь работают корректно

### v1.0.9 (2026-01-29)
- **Исправлено:** Factor Tree задания не распознавались ("Divide to fill in the blank")
  - InteractiveSliderSolver ошибочно срабатывал на Factor Tree iframe
  - Factor Tree содержит NumberLine в коде, но это дерево факторизации, не slider
  - Добавлена проверка: пропускаем iframe с `FactorTree` или `originalTree`
  - Теперь FactorTreeSolver корректно обрабатывает задания
  - Пример: `90 = ? × 3` с токенами `[125, 30, 5]`

### v1.0.8 (2026-01-29)
- **Исправлено:** Непрерывные sliders не распознавались ("Get as close as you can")
  - InteractiveSliderSolver пропускал NumberLine iframe с упоминанием "ExpressionBuild"
  - Добавлена проверка признаков настоящего slider:
    * `disableSnapping: true` - непрерывный slider
    * `fillToValue: true` - дискретный slider с fill
    * `density` конфигурация (TWO_PRIMARY, SEVEN_PRIMARY)
  - Теперь решает оба типа: дискретные (`150÷25=?`) и непрерывные (`?÷30=3`)

### v1.0.7 (2026-01-29)
- **Исправлено:** NumberLine slider не распознавался для заданий "Answer on the line"
  - ExpressionBuildSolver ошибочно срабатывал на NumberLine iframe
  - Изменён порядок регистрации: InteractiveSliderSolver → ExpressionBuildSolver
  - Добавлена проверка исключения NumberLine iframe в ExpressionBuildSolver
  - Теперь правильно решает задания: `150÷25 = ?` с интерактивным слайдером

### v1.0.6 (2026-01-29)
- **Исправлено:** MatchPairsSolver неправильно решал задания с делением
  - `isCompoundExpression` теперь распознаёт `/` и `÷` как составные выражения
  - Fallback режим предпочитает сопоставлять выражения с простыми числами
  - Двухпроходная логика: (1) expr→num, (2) any→any для edge cases
  - Теперь правильно решает задания типа: `45÷5` ↔ `9`, `25÷5` ↔ `5`, `80÷10` ↔ `8`

### v1.0.5 (2026-01-25)
- **Улучшено:** Factor Tree (Дерево факторов) - улучшен алгоритм решения
  - Реализован post-order обход дерева (дети обрабатываются перед родителями)
  - Добавлен итеративный refinement для сложных случаев
  - Расчет из родителя и сиблинга когда дети неизвестны (child = parent / sibling)
  - Множественные проходы до тех пор, пока больше нельзя вычислить значения
  - Теперь решает деревья с несколькими неизвестными
- **Добавлено:** Поддержка списков факторов в MatchPairsSolver
  - Определение токенов с comma-separated числами (e.g., "1, 4, 5, 10")
  - Сопоставление чисел со списками их факторов
- **Добавлено:** Поддержка LaTeX скобок и возведения в степень
  - `\left(` `\right)` `\left[` `\right]` и др. → стандартные скобки
  - Возведение в степень: `base^exponent` → `base**exponent`
  - Улучшена обработка математических выражений

### v1.0.4 (2026-01-25)
- **Исправлено:** Задания "Show this another way" с блок-диаграммами в вариантах выбора (число → блок-диаграмма)
  - `BlockDiagramChoiceSolver` теперь поддерживает новый вариант: уравнение показывает число (200), выборы показывают блок-диаграммы
  - Исправлена логика подсчета блоков: теперь считаются ВСЕ rect и path элементы (каждый = 1 блок), а не столбцы
  - Добавлены fallback-методы для извлечения целевого значения из уравнения
  - Улучшено логирование для отладки
- **Исправлено:** Нестабильное автоматическое нажатие кнопки "Continue"
  - Реализована асинхронная функция `clickContinueButtonAsync` с MutationObserver
  - Использует polling + MutationObserver для надежного ожидания активации кнопки
  - `AutoRunner` обновлен для использования асинхронной версии во всех местах

### v1.0.3 (2026-01-25)
- **Исправлено:** Неполное решение заданий типа "Match the Pairs"
  - `MatchPairsSolver` теперь кликает все пары последовательно, а не только первую
  - Улучшена логика `canSolve()`: теперь проверяет наличие активных (незаблокированных) токенов
  - Добавлена обработка случая, когда все пары уже сопоставлены (задание завершено)
  - Теперь задания "Match the Pairs" решаются полностью до завершения

### v1.0.2 (2026-01-25)
- **Исправлено:** Ошибочный выбор `InteractiveSpinnerSolver` для заданий типа `NumberLine`
  - Уточнена логика `InteractiveSpinnerSolver.canSolve()`: добавлена явная проверка исключения для компонентов `NumberLine` и `ExpressionBuild`
  - Это предотвращает ложное срабатывание на задания с числовой линией, которые могут содержать строку 'segments:' в HTML
  - Теперь задания с числовой линией (NumberLine) корректно обрабатываются `InteractiveSliderSolver`

### v1.0.1 (2026-01-25)
- **Исправлено:** Ошибочный выбор `ExpressionBuildSolver` для заданий типа `NumberLine`
  - Уточнена логика `ExpressionBuildSolver.canSolve()`: теперь проверяется наличие уравнения с `\duoblank`
  - Это предотвращает ложное срабатывание на чистые NumberLine задания, которые могут содержать строки 'exprBuild' или 'ExpressionBuild' в комментариях/переменных
  - Теперь задания с числовой линией (NumberLine) корректно обрабатываются `InteractiveSliderSolver`

### v1.0.0 (2026-01-27)
- **Исправлено:** Ошибочный выбор `InteractiveSliderSolver` для заданий типа `ExpressionBuild`
  - `ExpressionBuildSolver` теперь регистрируется перед `InteractiveSliderSolver` в `SolverRegistry`
  - Добавлена проверка исключения в `InteractiveSliderSolver.canSolve()` для фильтрации iframe с ExpressionBuild
  - Теперь задания "Построй выражение" (например, `300 = ___` → `3 × 100`) решаются корректно

## Лицензия

[MIT](LICENSE)

## Дисклеймер

Этот проект создан в образовательных целях. Используйте на свой страх и риск.
